services:
  # AWS CLI containers for each account
  awscli-account1:
    build: .
    image: aws-security-hub-soc:latest
    container_name: aws-security-hub-account1
    working_dir: /aws-scripts
    volumes:
      - ./aws-scripts:/aws-scripts
      - ./aws-credentials:/aws-credentials:ro
      - ./data-processor:/data-processor
      - ./output:/output
      - ./docs:/docs:ro
      - ./templates:/templates:ro
      - ./scripts:/scripts:ro
    environment:
      - AWS_DEFAULT_REGION=eu-central-1
      - ACCOUNT_NAME=account1
    entrypoint: ["/bin/bash"]
    tty: true
    stdin_open: true
    networks:
      - aws-security-network

  awscli-account2:
    build: .
    image: aws-security-hub-soc:latest
    container_name: aws-security-hub-account2
    working_dir: /aws-scripts
    volumes:
      - ./aws-scripts:/aws-scripts
      - ./aws-credentials:/aws-credentials:ro
      - ./data-processor:/data-processor
      - ./output:/output
      - ./docs:/docs:ro
      - ./templates:/templates:ro
      - ./scripts:/scripts:ro
    environment:
      - AWS_DEFAULT_REGION=eu-central-1
      - ACCOUNT_NAME=account2
    entrypoint: ["/bin/bash"]
    tty: true
    stdin_open: true
    networks:
      - aws-security-network

  awscli-account3:
    build: .
    image: aws-security-hub-soc:latest
    container_name: aws-security-hub-account3
    working_dir: /aws-scripts
    volumes:
      - ./aws-scripts:/aws-scripts
      - ./aws-credentials:/aws-credentials:ro
      - ./data-processor:/data-processor
      - ./output:/output
      - ./docs:/docs:ro
      - ./templates:/templates:ro
      - ./scripts:/scripts:ro
    environment:
      - AWS_DEFAULT_REGION=eu-central-1
      - ACCOUNT_NAME=account3
    entrypoint: ["/bin/bash"]
    tty: true
    stdin_open: true
    networks:
      - aws-security-network

  security-hub-aggregator:
    build: .
    image: aws-security-hub-soc:latest
    container_name: aws-security-hub-aggregator
    working_dir: /aws-scripts
    volumes:
      - ./aws-scripts:/aws-scripts
      - ./aws-credentials:/aws-credentials:ro
      - ./data-processor:/data-processor
      - ./output:/output
      - ./docs:/docs:ro
      - ./templates:/templates:ro
      - ./scripts:/scripts:ro
    environment:
      - AWS_DEFAULT_REGION=eu-central-1
      - ACCOUNT_NAME=master
    entrypoint: ["/bin/bash"]
    tty: true
    stdin_open: true
    networks:
      - aws-security-network

  # Flask Dashboard for Security Hub Findings
  security-dashboard:
    build: 
      context: .
      dockerfile: Dockerfile-dashboard
    container_name: aws-security-hub-dashboard
    volumes:
      - ./data-processor:/data-processor
      - ./output:/output
      - ./templates:/templates:ro
    ports:
      - "5001:5000"
    environment:
      - FLASK_ENV=development
    networks:
      - aws-security-network
    depends_on:
      - awscli-account1
      - awscli-account2
      - awscli-account3

networks:
  aws-security-network:
    driver: bridge
